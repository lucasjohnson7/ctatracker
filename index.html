<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <title>CTA Wall — Southport</title>
</head>

<body>

<!-- Simple top bar: just timestamp on the right -->
<header>
  <div class="timestamp" id="timestamp">Loading…</div>
</header>

<!-- ARRIVAL LISTS (no backgrounds or panels) -->
<section class="list">

  <!-- BROWN LOOP -->
  <div class="marquee">
    <span class="station-label">Brown Line → Loop</span>
    <img src="./train.png" class="runner" id="trainLoopRun" />
  </div>
  <div id="trainLoopBody" class="arrival-group">Loading…</div>

  <!-- BROWN KIMBALL -->
  <div class="marquee">
    <span class="station-label">Brown Line → Kimball</span>
    <img src="./train.png" class="runner" id="trainKimballRun" />
  </div>
  <div id="trainKimballBody" class="arrival-group">Loading…</div>

  <!-- BUS EAST -->
  <div class="marquee">
    <span class="station-label">#77 Eastbound → Lake Shore</span>
    <img src="./bus.png" class="runner" id="busEastRun" />
  </div>
  <div id="busEastBody" class="arrival-group">Loading…</div>

  <!-- BUS WEST -->
  <div class="marquee">
    <span class="station-label">#77 Westbound → Cumberland</span>
    <img src="./bus.png" class="runner" id="busWestRun" />
  </div>
  <div id="busWestBody" class="arrival-group">Loading…</div>

</section>

<!-- Bottom row: Music (left) + Weather (right, fixed size) -->
<section class="bottom-row">
  <!-- Lock-screen style Now Playing -->
  <section class="nowplaying" id="nowplaying" aria-live="polite">
    <img id="npArt" class="np-art" alt="Album art" />
    <div class="np-meta">
      <div id="npTitle" class="np-title">Nothing playing</div>
      <div id="npArtist" class="np-artist">—</div>
      <div class="np-bar" id="npBar" hidden>
        <div class="np-bar-fill" id="npFill"></div>
      </div>
    </div>
  </section>

  <!-- Weather moved down here, beside music -->
  <div class="weather-shell">
    <div class="weather" id="weather">
      <img class="wx-icon" src="" alt="weather icon" />
      <div class="weather-info">
        <span class="wx-temp">--°</span>
        <span class="wx-desc">Loading...</span>
      </div>
    </div>
  </div>
</section>

<script>
const classify = (m)=> m<=1 ? "due" : (m<=5 ? "soon" : "ok");
const setStamp = ()=> document.getElementById("timestamp").textContent =
  "Updated " + new Date().toLocaleTimeString();

/* ===== Weather (Open-Meteo) using PNG icons ===== */
const WX_LAT=41.94, WX_LON=-87.66;
const WX_URL=`https://api.open-meteo.com/v1/forecast?latitude=${WX_LAT}&longitude=${WX_LON}&current=temperature_2m,weather_code&temperature_unit=fahrenheit`;

// ----- Auto Night Mode (6:01pm–5:59am) -----
function isNightNow(){
  const now = new Date();
  const h = now.getHours();
  const m = now.getMinutes();
  // night if 18:01–23:59 or 00:00–05:59
  return (h > 18) || (h === 18 && m >= 1) || (h < 6);
}

function applyThemeByTime(){
  const root = document.documentElement; // <html>
  if (isNightNow()) root.classList.add('night');
  else root.classList.remove('night');
}
applyThemeByTime();
// re-check every 5 minutes
setInterval(applyThemeByTime, 5 * 60 * 1000);

// Map Open-Meteo codes to your filenames
function wxIconFile(code, now=new Date()){
  const h=now.getHours(), m=now.getMinutes();
  const isDay=(h>6 && h<18)||(h===6)||(h===18&&m===0);

  if (code === 0) return isDay ? 'sun.png' : 'moon.png';              // clear
  if ([1,2].includes(code)) return 'partlycloudy.png';               // mostly clear / few clouds
  if (code === 3) return 'cloudy.png';                               // overcast / partly cloudy
  if ([45,48].includes(code)) return 'cloudy.png';                   // fog
  if ([51,53,55,56,57,61,63,65,66,67,80,81,82].includes(code)) return 'rain.png';  // drizzle/rain/showers
  if ([71,73,75,77,85,86].includes(code)) return 'snow.png';         // snow
  if ([95,96,99].includes(code)) return 'rain.png';                  // t-storms fallback
  return 'cloudy.png';
}

function wxText(code, now=new Date()){
  const h=now.getHours(), m=now.getMinutes();
  const isDay=(h>6 && h<18)||(h===6)||(h===18&&m===0);
  if (code === 0) return isDay ? 'Clear' : 'Clear';
  if ([1,2].includes(code)) return 'Mostly clear';
  if (code === 3) return 'Partly cloudy';
  if ([45,48].includes(code)) return 'Foggy';
  if ([51,53,55,56,57].includes(code)) return 'Drizzle';
  if ([61,63,65,66,67].includes(code)) return 'Rain';
  if ([80,81,82].includes(code)) return 'Showers';
  if ([71,73,75,77].includes(code)) return 'Snow';
  if ([85,86].includes(code)) return 'Snow showers';
  if ([95,96,99].includes(code)) return 'Thunderstorms';
  return 'Cloudy';
}

async function loadWeather(){
  try{
    const j=await (await fetch(WX_URL,{cache:'no-store'})).json();
    const t=Math.round(j.current.temperature_2m);
    const code=j.current.weather_code;

    const icon = wxIconFile(code);
    const text = wxText(code);

    const el=document.getElementById("weather");
    el.querySelector(".wx-icon").src = `./${icon}`;
    el.querySelector(".wx-icon").alt = text;
    el.querySelector(".wx-temp").textContent = t+"°F";
    el.querySelector(".wx-desc").textContent = text;
  }catch{
    const el=document.getElementById("weather");
    el.querySelector(".wx-icon").src='';
    el.querySelector(".wx-desc").textContent="Weather unavailable";
  }
}

/* ===== Runner controller (left→right; park; leave) ===== */
function controlRunner(el, due){
  if(!el) return;
  const state=el.dataset.state||"idle";
  const marquee=el.parentElement;
  const w=marquee.clientWidth;
  const blockW=el.clientWidth||120;
  const start=-200, park=Math.max(0,w-blockW-6), exit=w+300;

  function anim(from,to,dur,done){
    el.style.visibility="visible";
    const a=el.animate(
      [{transform:`translateX(${from}px)`},{transform:`translateX(${to}px)`}],
      {duration:dur,easing:"linear",fill:"forwards"}
    );
    a.onfinish=()=>{el.style.transform=`translateX(${to}px)`;done&&done();};
  }

  if(due){
    if(state==="idle"||state==="leaving"){
      el.dataset.state="arriving";
      anim(start,park,1500,()=>el.dataset.state="parked");
    }
  } else if (state==="parked"){
    el.dataset.state="leaving";
    anim(park,exit,900,()=>{
      el.dataset.state="idle";
      el.style.visibility="hidden";
      el.style.transform=`translateX(${start}px)`;
    });
  }
}

async function fetchJSON(url){
  const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw 0; return r.json();
}

/* Renders */
function renderList(rows, target, runner){
  const el=document.querySelector(target);
  if(!rows.length){
    el.innerHTML=`<div class="row empty">No predictions</div>`;
    controlRunner(document.querySelector(runner), false);
    return;
  }
  let anyDue=false;
  el.innerHTML=rows.slice(0,4).map(x=>{
    const mins=Math.max(0,Math.round((new Date(x.arrT)-new Date())/60000));
    if(mins<=1) anyDue=true;
    const eta=mins<=1?"DUE":`${mins} min`;
    return `<div class="row ${classify(mins)}">
      <div class="meta">
        <div class="route">Brown Line #${x.rn}</div>
        <div class="dest">${x.destNm}</div>
      </div>
      <div class="eta">${eta}</div>
    </div>`;
  }).join("");
  controlRunner(document.querySelector(runner), anyDue);
}

async function loadTrains(){
  try{
    const data=await fetchJSON("/api/train?mapid=40360");
    renderList(data.filter(x=>/Loop/i.test(x.stpDe||"")), "#trainLoopBody", "#trainLoopRun");
    renderList(data.filter(x=>/Kimball/i.test(x.stpDe||"")), "#trainKimballBody", "#trainKimballRun");
  }catch{
    document.querySelector("#trainLoopBody").innerHTML="<div class='row empty'>Error</div>";
    document.querySelector("#trainKimballBody").innerHTML="<div class='row empty'>Error</div>";
  }
}

function renderBus(rows, target, runner){
  const el=document.querySelector(target);
  if(!rows.length){
    el.innerHTML=`<div class="row empty">No predictions</div>`;
    controlRunner(document.querySelector(runner), false);
    return;
  }
  let anyDue=false;
  el.innerHTML=rows.slice(0,4).map(x=>{
    const mins=x.prdctdn==="DUE"?0:parseInt(x.prdctdn,10);
    if(mins<=1) anyDue=true;
    const eta=mins<=1?"DUE":`${mins} min`;
    return `<div class="row ${classify(mins)} bus-row">
      <div class="meta">
        <div class="route">#77 Vehicle ${x.vid}</div>
        <div class="dest">${x.des}</div>
      </div>
      <div class="eta">${eta}</div>
    </div>`;
  }).join("");
  controlRunner(document.querySelector(runner), anyDue);
}

async function loadBuses(){
  try{
    const [east,west]=await Promise.all([
      fetchJSON("/api/bus?stpid=17833&rt=77"),
      fetchJSON("/api/bus?stpid=14920&rt=77")
    ]);
    renderBus(east.rows||[], "#busEastBody", "#busEastRun");
    renderBus(west.rows||[], "#busWestBody", "#busWestRun");
  }catch{
    document.querySelector("#busEastBody").innerHTML="<div class='row empty'>Error</div>";
    document.querySelector("#busWestBody").innerHTML="<div class='row empty'>Error</div>";
  }
}

/* cadence */
async function refresh(){ await Promise.all([loadTrains(), loadBuses()]); setStamp(); }
refresh();
setInterval(refresh,20000);
loadWeather();
setInterval(loadWeather,300000);

async function loadNowPlaying(){
  try{
    const r = await fetch('/api/sonos/now-playing', { cache:'no-store' });
    const j = await r.json();

    const card = document.getElementById('nowplaying');
    const art  = document.getElementById('npArt');
    const t    = document.getElementById('npTitle');
    const a    = document.getElementById('npArtist');
    const bar  = document.getElementById('npBar');
    const fill = document.getElementById('npFill');

    if (j.playing){
      t.textContent = j.title || 'Playing…';
      a.textContent = [j.artist, j.album].filter(Boolean).join(' — ') || '—';

      if (j.image) {
        art.src = j.image;
        art.style.display = 'block';
      } else {
        art.removeAttribute('src');
        art.style.display = 'none';
      }

      // Optional progress support (positionMs / durationMs from your API)
      if (Number.isFinite(j.positionMs) && Number.isFinite(j.durationMs) && j.durationMs > 0){
        const pct = Math.max(0, Math.min(100, (j.positionMs / j.durationMs) * 100));
        fill.style.width = pct.toFixed(1) + '%';
        bar.hidden = false;
      } else {
        bar.hidden = true;
      }
    } else {
      t.textContent = 'Nothing playing';
      a.textContent = '';
      art.style.display = 'none';
      bar.hidden = true;
    }
  } catch(e){
    console.error(e);
  }
}

loadNowPlaying();
setInterval(loadNowPlaying, 10000);
</script>

</body>
</html>
