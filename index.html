<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <title>CTA Wall — Southport</title>
</head>

<body>

<!-- Simple top bar: just timestamp on the right -->
<header>
  <div class="timestamp" id="timestamp">Loading…</div>
</header>

<!-- ARRIVAL LISTS (no backgrounds or panels) -->
<section class="list">

  <!-- BROWN LOOP -->
  <div class="marquee">
    <span class="station-label">Brown Line → Loop</span>
    <img src="./train.png" class="runner" id="trainLoopRun" />
  </div>
  <div id="trainLoopBody" class="arrival-group">Loading…</div>

  <!-- BROWN KIMBALL -->
  <div class="marquee">
    <span class="station-label">Brown Line → Kimball</span>
    <img src="./train.png" class="runner" id="trainKimballRun" />
  </div>
  <div id="trainKimballBody" class="arrival-group">Loading…</div>

  <!-- BUS EAST -->
  <div class="marquee">
    <span class="station-label">#77 Eastbound → Lake Shore</span>
    <img src="./bus.png" class="runner" id="busEastRun" />
  </div>
  <div id="busEastBody" class="arrival-group">Loading…</div>

  <!-- BUS WEST -->
  <div class="marquee">
    <span class="station-label">#77 Westbound → Cumberland</span>
    <img src="./bus.png" class="runner" id="busWestRun" />
  </div>
  <div id="busWestBody" class="arrival-group">Loading…</div>

</section>

<!-- Bottom row: Music (left) + Weather / Date (top-right) + Sports (bottom-right) -->
<section class="bottom-row">
  <!-- Lock-screen style Now Playing -->
  <section class="nowplaying" id="nowplaying" aria-live="polite">
    <img id="npArt" class="np-art" alt="Album art" />
    <div class="np-meta">
      <div id="npTitle" class="np-title">Nothing playing</div>
      <div id="npArtist" class="np-artist">—</div>
      <div class="np-bar" id="npBar" hidden>
        <div class="np-bar-fill" id="npFill"></div>
      </div>
    </div>
  </section>

  <!-- Right-hand column: weather + date/time on top, sports full width below -->
  <div class="info-right">
    <div class="info-top">
      <!-- Weather card -->
      <div class="weather" id="weather">
        <img class="wx-icon" src="" alt="weather icon" />
        <div class="weather-info">
          <span class="wx-temp">--°</span>
          <span class="wx-desc">Loading...</span>
        </div>
      </div>

      <!-- Date / Time card -->
      <div class="datetime-card">
        <div class="dt-date" id="dtDate">Thu, Nov 13</div>
        <div class="dt-time" id="dtTime">1:49 PM</div>
      </div>
    </div>

    <!-- Sports card (wide, under both) -->
    <div class="sports-card" id="sportsCard">

      <!-- Creighton row -->
      <div class="sports-team scorebug" id="sports-creighton">
        <div class="scorebug-team scorebug-away">
          <div class="team-inner">
            <img class="team-logo team-away-logo" alt="">
            <div class="team-name team-away-name">Away</div>
          </div>
          <div class="team-score team-away-score">–</div>
        </div>

        <div class="scorebug-center">
          <div class="scorebug-center-top">@</div>
          <div class="scorebug-center-line1">Loading…</div>
          <div class="scorebug-center-line2"></div>
        </div>

        <div class="scorebug-team scorebug-home">
          <div class="team-score team-home-score">–</div>
          <div class="team-inner">
            <img class="team-logo team-home-logo" alt="">
            <div class="team-name team-home-name">Home</div>
          </div>
        </div>
      </div>

      <!-- Bulls row -->
      <div class="sports-team scorebug" id="sports-bulls">
        <div class="scorebug-team scorebug-away">
          <div class="team-inner">
            <img class="team-logo team-away-logo" alt="">
            <div class="team-name team-away-name">Away</div>
          </div>
          <div class="team-score team-away-score">–</div>
        </div>

        <div class="scorebug-center">
          <div class="scorebug-center-top">@</div>
          <div class="scorebug-center-line1">Loading…</div>
          <div class="scorebug-center-line2"></div>
        </div>

        <div class="scorebug-team scorebug-home">
          <div class="team-score team-home-score">–</div>
          <div class="team-inner">
            <img class="team-logo team-home-logo" alt="">
            <div class="team-name team-home-name">Home</div>
          </div>
        </div>
      </div>

      <!-- Bears row -->
      <div class="sports-team scorebug" id="sports-bears">
        <div class="scorebug-team scorebug-away">
          <div class="team-inner">
            <img class="team-logo team-away-logo" alt="">
            <div class="team-name team-away-name">Away</div>
          </div>
          <div class="team-score team-away-score">–</div>
        </div>

        <div class="scorebug-center">
          <div class="scorebug-center-top">@</div>
          <div class="scorebug-center-line1">Loading…</div>
          <div class="scorebug-center-line2"></div>
        </div>

        <div class="scorebug-team scorebug-home">
          <div class="team-score team-home-score">–</div>
          <div class="team-inner">
            <img class="team-logo team-home-logo" alt="">
            <div class="team-name team-home-name">Home</div>
          </div>
        </div>
      </div>
    </div>

  </div>
</section>

<script>
const classify = (m)=> m<=1 ? "due" : (m<=5 ? "soon" : "ok");

/* Timestamp + date/time card */
const setStamp = ()=>{
  const now = new Date();
  const ts = document.getElementById("timestamp");
  if (ts) ts.textContent = "Updated " + now.toLocaleTimeString();

  const dateEl = document.getElementById("dtDate");
  const timeEl = document.getElementById("dtTime");
  if (dateEl){
    dateEl.textContent = now.toLocaleDateString("en-US", {
      weekday:"short", month:"short", day:"numeric"
    });
  }
  if (timeEl){
    timeEl.textContent = now.toLocaleTimeString("en-US", {
      hour:"numeric", minute:"2-digit"
    });
  }
};

/* ===== Weather (Open-Meteo) using PNG icons ===== */
const WX_LAT=41.94, WX_LON=-87.66;
const WX_URL=`https://api.open-meteo.com/v1/forecast?latitude=${WX_LAT}&longitude=${WX_LON}&current=temperature_2m,weather_code&temperature_unit=fahrenheit`;

// ----- Auto Night Mode (6:01pm–5:59am) -----
function isNightNow(){
  const now = new Date();
  const h = now.getHours();
  const m = now.getMinutes();
  // night if 18:01–23:59 or 00:00–05:59
  return (h > 18) || (h === 18 && m >= 1) || (h < 6);
}

function applyThemeByTime(){
  const root = document.documentElement; // <html>
  if (isNightNow()) root.classList.add('night');
  else root.classList.remove('night');
}
applyThemeByTime();
setInterval(applyThemeByTime, 5 * 60 * 1000);

// Map Open-Meteo codes to your filenames
function wxIconFile(code, now=new Date()){
  const h=now.getHours(), m=now.getMinutes();
  const isDay=(h>6 && h<18)||(h===6)||(h===18&&m===0);

  if (code === 0) return isDay ? 'sun.png' : 'moon.png';              // clear
  if ([1,2].includes(code)) return 'partlycloudy.png';               // mostly clear / few clouds
  if (code === 3) return 'cloudy.png';                               // overcast / partly cloudy
  if ([45,48].includes(code)) return 'cloudy.png';                   // fog
  if ([51,53,55,56,57,61,63,65,66,67,80,81,82].includes(code)) return 'rain.png';  // drizzle/rain/showers
  if ([71,73,75,77,85,86].includes(code)) return 'snow.png';         // snow
  if ([95,96,99].includes(code)) return 'rain.png';                  // t-storms fallback
  return 'cloudy.png';
}

function wxText(code, now=new Date()){
  const h=now.getHours(), m=now.getMinutes();
  const isDay=(h>6 && h<18)||(h===6)||(h===18&&m===0);
  if (code === 0) return isDay ? 'Clear' : 'Clear';
  if ([1,2].includes(code)) return 'Mostly clear';
  if (code === 3) return 'Partly cloudy';
  if ([45,48].includes(code)) return 'Foggy';
  if ([51,53,55,56,57].includes(code)) return 'Drizzle';
  if ([61,63,65,66,67].includes(code)) return 'Rain';
  if ([80,81,82].includes(code)) return 'Showers';
  if ([71,73,75,77].includes(code)) return 'Snow';
  if ([85,86].includes(code)) return 'Snow showers';
  if ([95,96,99].includes(code)) return 'Thunderstorms';
  return 'Cloudy';
}

async function loadWeather(){
  try{
    const j=await (await fetch(WX_URL,{cache:'no-store'})).json();
    const t=Math.round(j.current.temperature_2m);
    const code=j.current.weather_code;

    const icon = wxIconFile(code);
    const text = wxText(code);

    const el=document.getElementById("weather");
    el.querySelector(".wx-icon").src = `./${icon}`;
    el.querySelector(".wx-icon").alt = text;
    el.querySelector(".wx-temp").textContent = t+"°F";
    el.querySelector(".wx-desc").textContent = text;
  }catch{
    const el=document.getElementById("weather");
    el.querySelector(".wx-icon").src='';
    el.querySelector(".wx-desc").textContent="Weather unavailable";
  }
}

/* ===== Runner controller (left→right; park; leave) ===== */
function controlRunner(el, due){
  if(!el) return;
  const state=el.dataset.state||"idle";
  const marquee=el.parentElement;
  const w=marquee.clientWidth;
  const blockW=el.clientWidth||120;
  const start=-200, park=Math.max(0,w-blockW-6), exit=w+300;

  function anim(from,to,dur,done){
    el.style.visibility="visible";
    const a=el.animate(
      [{transform:`translateX(${from}px)`},{transform:`translateX(${to}px)`}],
      {duration:dur,easing:"linear",fill:"forwards"}
    );
    a.onfinish=()=>{el.style.transform=`translateX(${to}px)`;done&&done();};
  }

  if(due){
    if(state==="idle"||state==="leaving"){
      el.dataset.state="arriving";
      anim(start,park,1500,()=>el.dataset.state="parked");
    }
  } else if (state==="parked"){
    el.dataset.state="leaving";
    anim(park,exit,900,()=>{
      el.dataset.state="idle";
      el.style.visibility="hidden";
      el.style.transform=`translateX(${start}px)`;
    });
  }
}

async function fetchJSON(url){
  const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw 0; return r.json();
}

/* Renders */
function renderList(rows, target, runner, maxRows){
  const el=document.querySelector(target);
  if(!rows.length){
    el.innerHTML=`<div class="row empty">No predictions</div>`;
    controlRunner(document.querySelector(runner), false);
    return;
  }
  const limit = typeof maxRows === 'number' ? maxRows : 4;
  let anyDue=false;
  el.innerHTML=rows.slice(0,limit).map(x=>{
    const mins=Math.max(0,Math.round((new Date(x.arrT)-new Date())/60000));
    if(mins<=1) anyDue=true;
    const eta=mins<=1?"DUE":`${mins} min`;
    return `<div class="row ${classify(mins)}">
      <div class="meta">
        <div class="route">Brown Line #${x.rn}</div>
        <div class="dest">${x.destNm}</div>
      </div>
      <div class="eta">${eta}</div>
    </div>`;
  }).join("");
  controlRunner(document.querySelector(runner), anyDue);
}

async function loadTrains(){
  try{
    const data=await fetchJSON("/api/train?mapid=40360");
    const loopRows    = data.filter(x=>/Loop/i.test(x.stpDe||""));
    const kimballRows = data.filter(x=>/Kimball/i.test(x.stpDe||""));
    // limits: Loop = 2, Kimball = 4
    renderList(loopRows,    "#trainLoopBody",   "#trainLoopRun",   2);
    renderList(kimballRows, "#trainKimballBody","#trainKimballRun",4);
  }catch{
    document.querySelector("#trainLoopBody").innerHTML="<div class='row empty'>Error</div>";
    document.querySelector("#trainKimballBody").innerHTML="<div class='row empty'>Error</div>";
  }
}

function renderBus(rows, target, runner, maxRows){
  const el=document.querySelector(target);
  if(!rows.length){
    el.innerHTML=`<div class="row empty">No predictions</div>`;
    controlRunner(document.querySelector(runner), false);
    return;
  }
  const limit = typeof maxRows === 'number' ? maxRows : 4;
  let anyDue=false;
  el.innerHTML=rows.slice(0,limit).map(x=>{
    const mins=x.prdctdn==="DUE"?0:parseInt(x.prdctdn,10);
    if(mins<=1) anyDue=true;
    const eta=mins<=1?"DUE":`${mins} min`;
    return `<div class="row ${classify(mins)} bus-row">
      <div class="meta">
        <div class="route">#77 Vehicle ${x.vid}</div>
        <div class="dest">${x.des}</div>
      </div>
      <div class="eta">${eta}</div>
    </div>`;
  }).join("");
  controlRunner(document.querySelector(runner), anyDue);
}

async function loadBuses(){
  try{
    const [east,west]=await Promise.all([
      fetchJSON("/api/bus?stpid=17833&rt=77"),
      fetchJSON("/api/bus?stpid=14920&rt=77")
    ]);
    // limits: 3 each
    renderBus(east.rows||[], "#busEastBody", "#busEastRun", 3);
    renderBus(west.rows||[], "#busWestBody", "#busWestRun", 3);
  }catch{
    document.querySelector("#busEastBody").innerHTML="<div class='row empty'>Error</div>";
    document.querySelector("#busWestBody").innerHTML="<div class='row empty'>Error</div>";
  }
}

/* ===== Scrolling text helper for Now Playing ===== */
function setScrollingText(el, text){
  el.style.setProperty('--scroll-distance', '0px');
  el.classList.remove('scrolling');
  el.innerHTML = '';

  const span = document.createElement('span');
  span.textContent = text || '';
  el.appendChild(span);

  requestAnimationFrame(() => {
    const containerWidth = el.clientWidth;
    const textWidth      = span.scrollWidth;
    const overflow       = textWidth - containerWidth;

    if (overflow > 8) {
      const distance = overflow + containerWidth * 0.5;
      el.style.setProperty('--scroll-distance', distance + 'px');
      el.classList.add('scrolling');
    }
  });
}
/* ===== Sports card (Creighton / Bulls / Bears — scorebug layout) ===== */

const SPORTS_TEAMS = [
  {
    id: 'sports-creighton',
    label: 'Creighton Bluejays',
    logo: './creighton.png',
    key: 'creighton'
  },
  {
    id: 'sports-bulls',
    label: 'Chicago Bulls',
    logo: './bulls.png',
    key: 'bulls'
  },
  {
    id: 'sports-bears',
    label: 'Chicago Bears',
    logo: './bears.png',
    key: 'bears'
  }
];

// we’ll stash the latest data here keyed by team.key
const SPORTS_STATE = {};

// Turn "Sun, Nov 16" into "TODAY" or "11/16"
function formatDateLabel(dateText){
  if (!dateText) return '';
  const today = new Date();
  const guess = new Date(dateText + ' ' + today.getFullYear());
  if (!isNaN(guess.getTime())){
    const sameDay =
      guess.getMonth() === today.getMonth() &&
      guess.getDate() === today.getDate();
    if (sameDay) return 'TODAY';
    const m = guess.getMonth() + 1;
    const d = guess.getDate();
    return `${m}/${d}`;
  }
  return dateText;
}

// sort key: live games first (0), then earliest start time
function gameSortKey(data){
  if (!data) return Number.POSITIVE_INFINITY;

  if (data.live) {
    // LIVE (or just finished) should always float to the top
    return 0;
  }

  const n = data.next;
  if (!n || !n.date) return Number.POSITIVE_INFINITY;

  const today = new Date();
  const baseYear = today.getFullYear();
  // n.date is like "Sat, Nov 16", n.time like "7:00 PM"
  const dateString = `${n.date} ${baseYear} ${n.time || ''}`;
  const guess = new Date(dateString);
  if (!isNaN(guess.getTime())) return guess.getTime();

  return Number.POSITIVE_INFINITY;
}

// Actually paint one row (same logic you already had, just reused)
function updateSportsRow(team, data){
  const row = document.getElementById(team.id);
  if (!row) return;

  const awayLogoEl   = row.querySelector('.team-away-logo');
  const homeLogoEl   = row.querySelector('.team-home-logo');
  const awayNameEl   = row.querySelector('.team-away-name');
  const homeNameEl   = row.querySelector('.team-home-name');
  const awayScoreEl  = row.querySelector('.team-away-score');
  const homeScoreEl  = row.querySelector('.team-home-score');
  const line1El      = row.querySelector('.scorebug-center-line1');
  const line2El      = row.querySelector('.scorebug-center-line2');

  // Defaults
  awayNameEl.textContent  = '';
  homeNameEl.textContent  = '';
  awayScoreEl.textContent = '–';
  homeScoreEl.textContent = '–';
  line1El.textContent     = 'No game today.';
  line2El.textContent     = '';

  // If we got nothing back at all, just show our team logo/name on left
  if (!data || (!data.live && !data.next)){
    awayNameEl.textContent = team.label;
    if (awayLogoEl && team.logo){
      awayLogoEl.src = team.logo;
    }
    if (homeLogoEl){
      homeLogoEl.removeAttribute('src');
    }
    return;
  }

  const live = data.live || null;
  const next = !live && data.next ? data.next : null;
  const payload = live || next;

  const isHome = (payload.homeAway || 'vs') === 'vs'; // from our perspective
  const ourName = team.label;
  const ourLogo = team.logo;
  const oppName = payload.opponentName || 'Opponent';
  const oppLogo = payload.opponentLogo || '';

  let homeName, homeLogo, awayName, awayLogo;

  if (isHome){
    homeName = ourName;
    homeLogo = ourLogo;
    awayName = oppName;
    awayLogo = oppLogo;
  } else {
    awayName = ourName;
    awayLogo = ourLogo;
    homeName = oppName;
    homeLogo = oppLogo;
  }

  awayNameEl.textContent = awayName;
  homeNameEl.textContent = homeName;

  if (awayLogoEl){
    const resolvedAwayLogo = awayLogo || (awayName === ourName ? ourLogo : '');
    if (resolvedAwayLogo) awayLogoEl.src = resolvedAwayLogo;
    else awayLogoEl.removeAttribute('src');
  }
  if (homeLogoEl){
    const resolvedHomeLogo = homeLogo || (homeName === ourName ? ourLogo : '');
    if (resolvedHomeLogo) homeLogoEl.src = resolvedHomeLogo;
    else homeLogoEl.removeAttribute('src');
  }

  if (live){
    const usScore =
      typeof live.usScore === 'number' ? live.usScore : null;
    const themScore =
      typeof live.themScore === 'number' ? live.themScore : null;

    let homeScore = null;
    let awayScore = null;

    if (isHome){
      homeScore = usScore;
      awayScore = themScore;
    } else {
      homeScore = themScore;
      awayScore = usScore;
    }

    awayScoreEl.textContent =
      Number.isFinite(awayScore) ? awayScore : '–';
    homeScoreEl.textContent =
      Number.isFinite(homeScore) ? homeScore : '–';

    const statusBits = [live.period, live.clock].filter(Boolean);
    line1El.textContent = statusBits.join(' ').trim() || 'LIVE';
    line2El.textContent = '';
  } else if (next){
    awayScoreEl.textContent = '–';
    homeScoreEl.textContent = '–';
    line1El.textContent = formatDateLabel(next.date);
    line2El.textContent = next.time || '';
  }
}

// Use the stored data to:
//  1) update each row's contents
//  2) reorder rows by soonest game / live on top
function renderSportsFromState(){
  const card = document.getElementById('sportsCard');
  if (!card) return;

  // Build an ordered array from the state + team list
  const states = SPORTS_TEAMS.map(team => ({
    team,
    data: (SPORTS_STATE[team.key] && SPORTS_STATE[team.key].data) || null
  }));

  // First, draw each row
  states.forEach(({team, data}) => updateSportsRow(team, data));

  // Then sort by live/next start time
  const sorted = states.slice().sort(
    (a, b) => gameSortKey(a.data) - gameSortKey(b.data)
  );

  // Re-append rows to the card
  sorted.forEach(({team}) => {
    const row = document.getElementById(team.id);
    if (row) card.appendChild(row);
  });
}

async function fetchTeamStatus(team){
  try{
    const res = await fetch(`/api/sports?team=${encodeURIComponent(team.key)}`, {
      cache: 'no-store'
    });
    if (!res.ok) throw new Error('bad status');
    const data = await res.json();
    SPORTS_STATE[team.key] = { data };
  } catch(e){
    console.error('sports error', team.key, e);
    SPORTS_STATE[team.key] = { data: null };
  }
  // After each fetch, redraw + reorder using whatever data we have
  renderSportsFromState();
}

function loadSports(){
  SPORTS_TEAMS.forEach(fetchTeamStatus);
}

// refresh periodically (e.g. every 2 min)
setInterval(loadSports, 120000);

/* cadence */
async function refresh(){
  await Promise.all([loadTrains(), loadBuses()]);
  setStamp();
}
refresh();
setInterval(refresh,20000);

loadWeather();
setInterval(loadWeather,300000);

function tickClocks(){
  setStamp();
}
tickClocks();
setInterval(tickClocks, 60000);

async function loadNowPlaying(){
  try{
    const r = await fetch('/api/sonos/now-playing', { cache:'no-store' });
    const j = await r.json();

    const art  = document.getElementById('npArt');
    const titleEl  = document.getElementById('npTitle');
    const artistEl = document.getElementById('npArtist');
    const bar  = document.getElementById('npBar');
    const fill = document.getElementById('npFill');

    if (j.playing){
      setScrollingText(titleEl, j.title || 'Playing…');
      setScrollingText(artistEl, [j.artist, j.album].filter(Boolean).join(' — ') || '—');

      if (j.image) {
        art.src = j.image;
        art.style.display = 'block';
      } else {
        art.removeAttribute('src');
        art.style.display = 'none';
      }

      if (Number.isFinite(j.positionMs) && Number.isFinite(j.durationMs) && j.durationMs > 0){
        const pct = Math.max(0, Math.min(100, (j.positionMs / j.durationMs) * 100));
        fill.style.width = pct.toFixed(1) + '%';
        bar.hidden = false;
      } else {
        bar.hidden = true;
      }
    } else {
      setScrollingText(titleEl, 'Nothing playing');
      setScrollingText(artistEl, '');
      art.style.display = 'none';
      bar.hidden = true;
    }
  } catch(e){
    console.error(e);
  }
}

loadNowPlaying();
setInterval(loadNowPlaying, 10000);
loadSports();
</script>

</body>
</html>
