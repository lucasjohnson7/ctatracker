<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="style.css" />
<title>CTA Wall ‚Äî Southport (Brown) + Belmont/Greenview</title>

<!-- Minimal styles for the sliding blocks over the colored marquee tiles -->
<style>
  /* Make sure marquee can position children */
  .marquee { position: relative; overflow: hidden; }

  /* The sliding ‚Äúblock‚Äù that runs over the marquee when DUE */
  .runner {
    position: absolute;
    top: 6px;
    right: -140px;                 /* start just off the right edge */
    width: 120px;
    height: 40px;
    border-radius: 8px;
    border: 2px solid #000;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 900;
    letter-spacing: .5px;
    box-shadow: inset 0 0 0 2px rgba(0,0,0,.25), 0 6px 18px rgba(0,0,0,.25);
    color: #1a1333;
    text-shadow: 0 1px 0 rgba(255,255,255,.25);
    opacity: .98;
    pointer-events: none;
  }
  .runner.train { background: #cdbbff; } /* lilac ‚Äútrain‚Äù block */
  .runner.bus   { background: #c7fff3; } /* aqua ‚Äúbus‚Äù block  */

  /* Animate from right ‚Üí left across the marquee area */
  .runner.roll { animation: slide-left 4s linear infinite; }
  @keyframes slide-left {
    from { transform: translateX(0); }
    to   { transform: translateX(calc(-100vw - 220px)); }
  }
</style>
</head>
<body>
<header>
  <h1>üöè CTA Wall ‚Äî Southport (Brown) + Belmont/Greenview (#77)</h1>
  <div class="timestamp" id="timestamp">Loading‚Ä¶</div>
</header>

<!-- Brown Line Panels -->
<section class="grid">
  <div class="panel brown" id="train-loop">
    <div class="marquee">
      <span class="station-label">Brown @ Southport ‚Üí Loop</span>
      <!-- sliding block lives ON the marquee -->
      <div class="runner train" id="trainLoopRun">TRAIN</div>
    </div>

    <div class="title">
      <h2>Inbound to Loop</h2>
      <span class="badge">mapid 40360</span>
    </div>
    <table>
      <thead><tr><th>ETA</th><th>Run</th><th>Dest</th></tr></thead>
      <tbody id="trainLoopBody"><tr><td colspan="3">Loading‚Ä¶</td></tr></tbody>
    </table>
    <div class="legend">
      <span><span class="dot"></span>DUE / ‚â§1m</span>
      <span><span class="dot"></span>‚â§5m</span>
    </div>
  </div>

  <div class="panel brown" id="train-kimball">
    <div class="marquee">
      <span class="station-label">Brown @ Southport ‚Üí Kimball</span>
      <div class="runner train" id="trainKimballRun">TRAIN</div>
    </div>

    <div class="title">
      <h2>Outbound to Kimball</h2>
      <span class="badge">mapid 40360</span>
    </div>
    <table>
      <thead><tr><th>ETA</th><th>Run</th><th>Dest</th></tr></thead>
      <tbody id="trainKimballBody"><tr><td colspan="3">Loading‚Ä¶</td></tr></tbody>
    </table>
    <div class="legend">
      <span><span class="dot"></span>DUE / ‚â§1m</span>
      <span><span class="dot"></span>‚â§5m</span>
    </div>
  </div>
</section>

<!-- Bus Panels -->
<section class="grid">
  <div class="panel" id="bus-east">
    <div class="marquee">
      <span class="station-label">#77 Belmont @ Greenview ‚Üí Diversey/Lake Shore</span>
      <div class="runner bus" id="busEastRun">BUS</div>
    </div>

    <div class="title">
      <h2>Eastbound</h2>
      <span class="badge">stop 17833</span>
    </div>
    <table>
      <thead><tr><th>ETA</th><th>Vehicle</th><th>Headed to</th></tr></thead>
      <tbody id="busEastBody"><tr><td colspan="3">Loading‚Ä¶</td></tr></tbody>
    </table>
    <div class="legend">
      <span><span class="dot"></span>DUE / ‚â§1m</span>
      <span><span class="dot"></span>‚â§5m</span>
    </div>
  </div>

  <div class="panel" id="bus-west">
    <div class="marquee">
      <span class="station-label">#77 Belmont @ Greenview ‚Üí Cumberland</span>
      <div class="runner bus" id="busWestRun">BUS</div>
    </div>

    <div class="title">
      <h2>Westbound</h2>
      <span class="badge">stop 14920</span>
    </div>
    <table>
      <thead><tr><th>ETA</th><th>Vehicle</th><th>Headed to</th></tr></thead>
      <tbody id="busWestBody"><tr><td colspan="3">Loading‚Ä¶</td></tr></tbody>
    </table>
    <div class="legend">
      <span><span class="dot"></span>DUE / ‚â§1m</span>
      <span><span class="dot"></span>‚â§5m</span>
    </div>
  </div>
</section>

<script>
const classify = (mins)=> mins <= 1 ? 'due' : (mins <= 5 ? 'soon' : 'ok');
const setStamp = ()=> document.getElementById('timestamp').textContent =
  'Updated ' + new Date().toLocaleTimeString();

/* Toggle / retrigger the sliding animation when DUE */
function animateIfDue(selector, isDue){
  const el = document.querySelector(selector);
  if(!el) return;
  el.classList.remove('roll');
  if(isDue){
    // reflow to restart the keyframe
    void el.offsetWidth;
    el.classList.add('roll');
  }
}

async function fetchJSON(url){
  const r = await fetch(url, { cache: 'no-store' });
  if(!r.ok) throw new Error('HTTP '+r.status);
  return r.json();
}

async function loadTrains(){
  try{
    const data = await fetchJSON('/api/train?mapid=40360'); // Southport
    const loop = data.filter(x => /Loop/i.test(x.stpDe || ''));
    const kimball = data.filter(x => /Kimball/i.test(x.stpDe || ''));

    const render = (rows, tbodySel, runnerSel)=>{
      const tbody = document.querySelector(tbodySel);
      if(!tbody) return;

      if(!rows.length){
        tbody.innerHTML = '<tr><td colspan="3">No predictions</td></tr>';
        animateIfDue(runnerSel, false);
        return;
      }

      let anyDue = false;
      tbody.innerHTML = rows.slice(0,5).map(x=>{
        const mins = Math.max(0, Math.round((new Date(x.arrT) - new Date())/60000));
        if(mins <= 1) anyDue = true;
        const cls = classify(mins);
        const eta = mins<=1 ? 'DUE' : `${mins} min`;
        return `<tr class="${cls}"><td>${eta}</td><td>${x.rn || ''}</td><td>${x.destNm || ''}</td></tr>`;
      }).join('');

      animateIfDue(runnerSel, anyDue);
    };

    render(loop,    '#trainLoopBody',    '#trainLoopRun');
    render(kimball, '#trainKimballBody', '#trainKimballRun');
  }catch(err){
    const msg = 'Train error: ' + (err?.message || err);
    ['#trainLoopBody','#trainKimballBody'].forEach(id=>{
      const el=document.querySelector(id);
      if(el) el.innerHTML = `<tr><td colspan="3">${msg}</td></tr>`;
    });
    animateIfDue('#trainLoopRun', false);
    animateIfDue('#trainKimballRun', false);
  }
}

async function loadBuses(){
  try{
    const [eastResp, westResp] = await Promise.all([
      fetchJSON('/api/bus?stpid=17833&rt=77'),
      fetchJSON('/api/bus?stpid=14920&rt=77')
    ]);

    const render = (resp, tbodySel, runnerSel) => {
      const tbody = document.querySelector(tbodySel);
      if (!tbody) return;

      const apiError = resp?.error;
      const rows = Array.isArray(resp) ? resp : (resp?.rows || []);

      if (apiError) {
        tbody.innerHTML = `<tr><td colspan="3">API error: ${apiError}</td></tr>`;
        animateIfDue(runnerSel, false);
        return;
      }

      if (!rows.length) {
        tbody.innerHTML = '<tr><td colspan="3">No predictions</td></tr>';
        animateIfDue(runnerSel, false);
        return;
      }

      let anyDue = false;
      tbody.innerHTML = rows.slice(0,5).map(x=>{
        const mins = (x.prdctdn === 'DUE') ? 0 : parseInt(x.prdctdn, 10);
        if (Number.isFinite(mins) && mins <= 1) anyDue = true;
        const cls = Number.isFinite(mins) ? classify(mins) : 'ok';
        const eta = !Number.isFinite(mins) ? '‚Äî' : (mins<=1 ? 'DUE' : `${mins} min`);
        return `<tr class="${cls}"><td>${eta}</td><td>${x.vid || ''}</td><td>${x.des || ''}</td></tr>`;
      }).join('');

      animateIfDue(runnerSel, anyDue);
    };

    render(eastResp, '#busEastBody', '#busEastRun');
    render(westResp, '#busWestBody', '#busWestRun');
  }catch(err){
    const msg = 'Bus error: ' + (err?.message || err);
    ['#busEastBody','#busWestBody'].forEach(id=>{
      const el=document.querySelector(id);
      if(el) el.innerHTML = `<tr><td colspan="3">${msg}</td></tr>`;
    });
    animateIfDue('#busEastRun', false);
    animateIfDue('#busWestRun', false);
  }
}

async function refresh(){
  await Promise.allSettled([ loadTrains(), loadBuses() ]);
  setStamp();
}

refresh();
setInterval(refresh, 20_000);
</script>
</body>
</html>
