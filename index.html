<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="style.css" />
<title>CTA Wall â€” Southport</title>
</head>

<body>

<header>
  <h1 class="board-title">Southport</h1>

  <div class="header-right">
    <div class="weather" id="weather">
      <span class="wx-emoji">â€¦</span>
      <span class="wx-temp">--Â°</span>
      <span class="wx-desc">Loading...</span>
    </div>
    <div class="timestamp" id="timestamp">Loadingâ€¦</div>
  </div>
</header>

<!-- ARRIVAL LISTS (no backgrounds or panels) -->
<section class="list">

  <!-- BROWN LOOP -->
  <div class="marquee">
    <span class="station-label">Brown Line â†’ Loop</span>
    <img src="./train.png" class="runner" id="trainLoopRun" />
  </div>
  <div id="trainLoopBody" class="arrival-group">Loadingâ€¦</div>

  <!-- BROWN KIMBALL -->
  <div class="marquee">
    <span class="station-label">Brown Line â†’ Kimball</span>
    <img src="./train.png" class="runner" id="trainKimballRun" />
  </div>
  <div id="trainKimballBody" class="arrival-group">Loadingâ€¦</div>

  <!-- BUS EAST -->
  <div class="marquee">
    <span class="station-label">#77 Eastbound â†’ Lake Shore</span>
    <img src="./bus.png" class="runner" id="busEastRun" />
  </div>
  <div id="busEastBody" class="arrival-group">Loadingâ€¦</div>

  <!-- BUS WEST -->
  <div class="marquee">
    <span class="station-label">#77 Westbound â†’ Cumberland</span>
    <img src="./bus.png" class="runner" id="busWestRun" />
  </div>
  <div id="busWestBody" class="arrival-group">Loadingâ€¦</div>

</section>

<script>
/* SAME JS AS BEFORE â€” unchanged except output formatting */

const classify = (m)=> m<=1 ? "due" : (m<=5 ? "soon" : "ok");
const setStamp = ()=> document.getElementById("timestamp").textContent =
  "Updated " + new Date().toLocaleTimeString();

/* WEATHER */
const WX_LAT=41.94, WX_LON=-87.66;
const WX_URL=`https://api.open-meteo.com/v1/forecast?latitude=${WX_LAT}&longitude=${WX_LON}&current=temperature_2m,weather_code&temperature_unit=fahrenheit`;

function wxIconAndText(code, now=new Date()){
  const h=now.getHours(), m=now.getMinutes();
  const isDay=(h>6 && h<18)||(h===6)||(h===18&&m===0);
  if(code===0) return {emoji:isDay?'â˜€ï¸':'ðŸŒ™', text:'Clear'};
  if([1,2].includes(code)) return {emoji:isDay?'ðŸŒ¤ï¸':'â›…ï¸', text:"Mostly clear"};
  if(code===3) return {emoji:"â›…ï¸", text:"Partly cloudy"};
  if([45,48].includes(code)) return {emoji:"ðŸŒ«ï¸", text:"Foggy"};
  if([51,53,55,56,57].includes(code)) return {emoji:"ðŸŒ¦ï¸", text:"Drizzle"};
  if([61,63,65,66,67].includes(code)) return {emoji:"ðŸŒ§ï¸", text:"Rain"};
  if([80,81,82].includes(code)) return {emoji:"ðŸŒ§ï¸", text:"Showers"};
  if([71,73,75,77].includes(code)) return {emoji:"â„ï¸", text:"Snow"};
  if([85,86].includes(code)) return {emoji:"â„ï¸", text:"Snow showers"};
  if([95,96,99].includes(code)) return {emoji:"â›ˆï¸", text:"Thunderstorms"};
  return {emoji:"â˜ï¸", text:"Cloudy"};
}

async function loadWeather(){
  try{
    const j=await (await fetch(WX_URL)).json();
    const t=Math.round(j.current.temperature_2m);
    const code=j.current.weather_code;
    const {emoji,text}=wxIconAndText(code);
    const el=document.getElementById("weather");
    el.querySelector(".wx-emoji").textContent=emoji;
    el.querySelector(".wx-temp").textContent=t+"Â°F";
    el.querySelector(".wx-desc").textContent=text;
  }catch{
    document.getElementById("weather").querySelector(".wx-desc").textContent="Unavailable";
  }
}

/* RUNNERS SAME AS BEFORE */
function controlRunner(el, due){
  if(!el) return;
  const state=el.dataset.state||"idle";
  const marquee=el.parentElement;
  const w=marquee.clientWidth;
  const blockW=el.clientWidth||120;
  const start=-200, park=w-blockW, exit=w+300;

  function anim(from,to,dur,done){
    el.style.visibility="visible";
    const a=el.animate([{transform:`translateX(${from}px)`},{transform:`translateX(${to}px)`}],{
      duration:dur, easing:"linear", fill:"forwards"
    });
    a.onfinish=()=>{el.style.transform=`translateX(${to}px)`;done&&done();};
  }

  if(due){
    if(state==="idle"||state==="leaving"){
      el.dataset.state="arriving";
      anim(start,park,1500,()=>el.dataset.state="parked");
    }
  } else {
    if(state==="parked"){
      el.dataset.state="leaving";
      anim(park,exit,900,()=>{
        el.dataset.state="idle";
        el.style.visibility="hidden";
        el.style.transform=`translateX(${start}px)`;
      });
    }
  }
}

async function fetchJSON(url){
  const r=await fetch(url); if(!r.ok) throw 0; return r.json();
}

/* TRAIN RENDERING (NO TABLES â€” PURE MESSAGE BOARD FORMAT) */
function renderList(rows, target, runner){
  const el=document.querySelector(target);

  if(!rows.length){
    el.innerHTML=`<div class="row empty">No predictions</div>`;
    controlRunner(document.querySelector(runner), false);
    return;
  }

  let anyDue=false;
  el.innerHTML=rows.slice(0,5).map(x=>{
    const mins=Math.max(0,Math.round((new Date(x.arrT)-new Date())/60000));
    if(mins<=1) anyDue=true;
    const eta=mins<=1?"DUE":`${mins} min`;
    return `
      <div class="row ${classify(mins)}">
        <div class="meta">
          <div class="route">Brown Line #${x.rn}</div>
          <div class="dest">${x.destNm}</div>
        </div>
        <div class="eta">${eta}</div>
      </div>
    `;
  }).join("");

  controlRunner(document.querySelector(runner), anyDue);
}

async function loadTrains(){
  try{
    const data=await fetchJSON("/api/train?mapid=40360");
    const loop=data.filter(x=>/Loop/i.test(x.stpDe||""));
    const kimb=data.filter(x=>/Kimball/i.test(x.stpDe||""));
    renderList(loop, "#trainLoopBody", "#trainLoopRun");
    renderList(kimb, "#trainKimballBody", "#trainKimballRun");
  }catch{
    document.querySelector("#trainLoopBody").innerHTML="<div class='row empty'>Error</div>";
    document.querySelector("#trainKimballBody").innerHTML="<div class='row empty'>Error</div>";
  }
}

/* BUS RENDERING */
function renderBus(rows, target, runner){
  const el=document.querySelector(target);

  if(!rows.length){
    el.innerHTML=`<div class="row empty">No predictions</div>`;
    controlRunner(document.querySelector(runner), false);
    return;
  }

  let anyDue=false;
  el.innerHTML=rows.slice(0,5).map(x=>{
    const mins=x.prdctdn==="DUE"?0:parseInt(x.prdctdn,10);
    if(mins<=1) anyDue=true;
    const eta=mins<=1?"DUE":`${mins} min`;
    return `
      <div class="row ${classify(mins)} bus-row">
        <div class="meta">
          <div class="route">#77 Vehicle ${x.vid}</div>
          <div class="dest">${x.des}</div>
        </div>
        <div class="eta">${eta}</div>
      </div>
    `;
  }).join("");

  controlRunner(document.querySelector(runner), anyDue);
}

async function loadBuses(){
  try{
    const [east,west]=await Promise.all([
      fetchJSON("/api/bus?stpid=17833&rt=77"),
      fetchJSON("/api/bus?stpid=14920&rt=77")
    ]);

    renderBus(east.rows||[], "#busEastBody", "#busEastRun");
    renderBus(west.rows||[], "#busWestBody", "#busWestRun");

  }catch{
    document.querySelector("#busEastBody").innerHTML="<div class='row empty'>Error</div>";
    document.querySelector("#busWestBody").innerHTML="<div class='row empty'>Error</div>";
  }
}

async function refresh(){
  await Promise.all([loadTrains(), loadBuses()]);
  setStamp();
}

refresh();
setInterval(refresh,20000);
loadWeather();
setInterval(loadWeather,300000);
</script>

</body>
</html>
