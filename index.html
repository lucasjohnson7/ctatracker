<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="style.css" />
<title>CTA Wall ‚Äî Southport (Brown) + Belmont/Greenview</title>

<!-- Minimal styles for image runners + weather -->
<style>
  .marquee { position: relative; overflow: hidden; }

  /* Runner image (train/bus) */
  .runner {
    position: absolute;
    top: 4px;
    left: 0;
    transform: translateX(-160px); /* start offscreen left */
    height: 44px;                  /* sprite height; adjust as you like */
    width: auto;
    filter: drop-shadow(0 6px 12px rgba(0,0,0,.25));
    image-rendering: pixelated;    /* crisp retro pixels */
    pointer-events: none;
    visibility: hidden;            /* hidden until we animate */
  }
  .runner.parked { /* transform managed via JS */ }

  /* Header layout: title left, weather+timestamp right (stacked) */
  header {
    display:flex; align-items:flex-start; justify-content:space-between; gap:16px;
  }
  .header-right {
    display:flex; flex-direction:column; align-items:flex-end; gap:6px;
    min-width: 180px;
  }

  /* Weather pill */
  .weather {
    display:flex; align-items:center; gap:10px;
    padding:6px 10px; border-radius:12px;
    background: rgba(0,0,0,0.15);
    border: 1px solid rgba(255,255,255,0.12);
    font-size: 14px;
    line-height: 1.1;
  }
  .weather .wx-emoji { font-size: 18px; }
  .weather .wx-temp { font-weight: 700; }
  .weather .wx-desc { opacity: .9; }
  .timestamp { opacity:.7; font-size:14px; }

  /* Make sure header wraps nicely on narrow widths */
  @media (max-width: 720px){
    header { flex-direction: column; align-items:flex-start; }
    .header-right { align-items:flex-start; }
  }
</style>
</head>
<body>
<header>
  <h1>üöè CTA Wall ‚Äî Southport (Brown) + Belmont/Greenview (#77)</h1>

  <div class="header-right">
    <!-- Weather shows here -->
    <div class="weather" id="weather">
      <span class="wx-emoji">‚Ä¶</span>
      <span class="wx-temp">--¬∞</span>
      <span class="wx-desc">Loading weather‚Ä¶</span>
    </div>

    <!-- Updated time -->
    <div class="timestamp" id="timestamp">Loading‚Ä¶</div>
  </div>
</header>

<!-- Brown Line Panels -->
<section class="grid">
  <div class="panel brown" id="train-loop">
    <div class="marquee">
      <span class="station-label">Brown @ Southport ‚Üí Loop</span>
      <img src="./train.png" alt="Train" class="runner" id="trainLoopRun" />
    </div>

    <div class="title">
      <h2>Inbound to Loop</h2>
      <span class="badge">mapid 40360</span>
    </div>
    <table>
      <thead><tr><th>ETA</th><th>Run</th><th>Dest</th></tr></thead>
      <tbody id="trainLoopBody"><tr><td colspan="3">Loading‚Ä¶</td></tr></tbody>
    </table>
    <div class="legend">
      <span><span class="dot"></span>DUE / ‚â§1m</span>
      <span><span class="dot"></span>‚â§5m</span>
    </div>
  </div>

  <div class="panel brown" id="train-kimball">
    <div class="marquee">
      <span class="station-label">Brown @ Southport ‚Üí Kimball</span>
      <img src="./train.png" alt="Train" class="runner" id="trainKimballRun" />
    </div>

    <div class="title">
      <h2>Outbound to Kimball</h2>
      <span class="badge">mapid 40360</span>
    </div>
    <table>
      <thead><tr><th>ETA</th><th>Run</th><th>Dest</th></tr></thead>
      <tbody id="trainKimballBody"><tr><td colspan="3">Loading‚Ä¶</td></tr></tbody>
    </table>
    <div class="legend">
      <span><span class="dot"></span>DUE / ‚â§1m</span>
      <span><span class="dot"></span>‚â§5m</span>
    </div>
  </div>
</section>

<!-- Bus Panels -->
<section class="grid">
  <div class="panel" id="bus-east">
    <div class="marquee">
      <span class="station-label">#77 Belmont @ Greenview ‚Üí Diversey/Lake Shore</span>
      <img src="./bus.png" alt="Bus" class="runner" id="busEastRun" />
    </div>

    <div class="title">
      <h2>Eastbound</h2>
      <span class="badge">stop 17833</span>
    </div>
    <table>
      <thead><tr><th>ETA</th><th>Vehicle</th><th>Headed to</th></tr></thead>
      <tbody id="busEastBody"><tr><td colspan="3">Loading‚Ä¶</td></tr></tbody>
    </table>
    <div class="legend">
      <span><span class="dot"></span>DUE / ‚â§1m</span>
      <span><span class="dot"></span>‚â§5m</span>
    </div>
  </div>

  <div class="panel" id="bus-west">
    <div class="marquee">
      <span class="station-label">#77 Belmont @ Greenview ‚Üí Cumberland</span>
      <img src="./bus.png" alt="Bus" class="runner" id="busWestRun" />
    </div>

    <div class="title">
      <h2>Westbound</h2>
      <span class="badge">stop 14920</span>
    </div>
    <table>
      <thead><tr><th>ETA</th><th>Vehicle</th><th>Headed to</th></tr></thead>
      <tbody id="busWestBody"><tr><td colspan="3">Loading‚Ä¶</td></tr></tbody>
    </table>
    <div class="legend">
      <span><span class="dot"></span>DUE / ‚â§1m</span>
      <span><span class="dot"></span>‚â§5m</span>
    </div>
  </div>
</section>

<script>
const classify = (mins)=> mins <= 1 ? 'due' : (mins <= 5 ? 'soon' : 'ok');
const setStamp = ()=> document.getElementById('timestamp').textContent =
  'Updated ' + new Date().toLocaleTimeString();

/* ===== Weather (Open-Meteo) ===== */
const WX_LAT = 41.94, WX_LON = -87.66; // ~1454 W School St
const WX_URL = `https://api.open-meteo.com/v1/forecast?latitude=${WX_LAT}&longitude=${WX_LON}&current=temperature_2m,weather_code&temperature_unit=fahrenheit`;

function wxIconAndText(code){
  // Open-Meteo weather codes mapping
  // 0 clear, 1-3 partly cloudy, 45/48 fog, 51-57 drizzle, 61-67 rain,
  // 71-77 snow, 80-82 showers, 85-86 snow showers, 95-99 thunder
  if (code === 0) return {emoji:'‚òÄÔ∏è', text:'Clear'};
  if ([1,2].includes(code)) return {emoji:'üå§Ô∏è', text:'Mostly sunny'};
  if (code === 3) return {emoji:'‚õÖÔ∏è', text:'Partly cloudy'};
  if ([45,48].includes(code)) return {emoji:'üå´Ô∏è', text:'Foggy'};
  if ([51,53,55,56,57].includes(code)) return {emoji:'üå¶Ô∏è', text:'Drizzle'};
  if ([61,63,65,66,67].includes(code)) return {emoji:'üåßÔ∏è', text:'Rain'};
  if ([80,81,82].includes(code)) return {emoji:'üåßÔ∏è', text:'Showers'};
  if ([71,73,75,77].includes(code)) return {emoji:'‚ùÑÔ∏è', text:'Snow'};
  if ([85,86].includes(code)) return {emoji:'‚ùÑÔ∏è', text:'Snow showers'};
  if ([95,96,99].includes(code)) return {emoji:'‚õàÔ∏è', text:'Thunderstorms'};
  return {emoji:'‚òÅÔ∏è', text:'Cloudy'};
}

async function loadWeather(){
  try{
    const r = await fetch(WX_URL, { cache: 'no-store' });
    const j = await r.json();
    const tempF = Math.round(j?.current?.temperature_2m ?? NaN);
    const code = j?.current?.weather_code ?? 3;
    const {emoji, text} = wxIconAndText(code);

    const el = document.getElementById('weather');
    if (el){
      el.querySelector('.wx-emoji').textContent = emoji;
      el.querySelector('.wx-temp').textContent = Number.isFinite(tempF) ? `${tempF}¬∞F` : '--¬∞';
      el.querySelector('.wx-desc').textContent = text;
    }
  }catch(e){
    const el = document.getElementById('weather');
    if (el){
      el.querySelector('.wx-emoji').textContent = '‚Ä¶';
      el.querySelector('.wx-temp').textContent = '--¬∞';
      el.querySelector('.wx-desc').textContent = 'Weather unavailable';
    }
  }
}

/* ===== Runner controller (left‚Üíright; park; leave) ===== */
function controlRunner(el, due){
  if(!el) return;
  const state = el.dataset.state || 'idle';

  const marquee = el.parentElement;
  const w = marquee.clientWidth;
  const blockW = el.clientWidth || 140;
  const startX = -160;                 // offscreen left
  const parkX  = Math.max(0, w - blockW - 8);  // far-right inside
  const exitX  = w + 200;              // offscreen right

  const animateTo = (fromX, toX, duration, onfinish) => {
    el.style.visibility = 'visible';
    el.style.willChange = 'transform';
    el.style.transform = `translateX(${fromX}px)`;
    const anim = el.animate(
      [{ transform: `translateX(${fromX}px)` },
       { transform: `translateX(${toX}px)` }],
      { duration, easing: 'linear', fill: 'forwards' }
    );
    anim.onfinish = () => {
      el.style.transform = `translateX(${toX}px)`;
      el.style.willChange = 'auto';
      onfinish && onfinish();
    };
  };

  if (due) {
    if (state === 'idle' || state === 'leaving') {
      el.dataset.state = 'arriving';
      animateTo(startX, parkX, 1200, () => {
        el.dataset.state = 'parked';
      });
    }
  } else {
    if (state === 'parked') {
      el.dataset.state = 'leaving';
      animateTo(parkX, exitX, 800, () => {
        el.dataset.state = 'idle';
        el.style.visibility = 'hidden';
        el.style.transform = `translateX(${startX}px)`; // reset
      });
    }
  }
}

/* ===== Fetch helpers ===== */
async function fetchJSON(url){
  const r = await fetch(url, { cache: 'no-store' });
  if(!r.ok) throw new Error('HTTP '+r.status);
  return r.json();
}

/* ===== Trains/Buses ===== */
async function loadTrains(){
  try{
    const data = await fetchJSON('/api/train?mapid=40360');
    const loop = data.filter(x => /Loop/i.test(x.stpDe || ''));
    const kimball = data.filter(x => /Kimball/i.test(x.stpDe || ''));

    const render = (rows, tbodySel, runnerSel)=>{
      const tbody = document.querySelector(tbodySel);
      const runner = document.querySelector(runnerSel);
      if(!tbody) return;

      if(!rows.length){
        tbody.innerHTML = '<tr><td colspan="3">No predictions</td></tr>';
        controlRunner(runner, false);
        return;
      }

      let anyDue = false;
      tbody.innerHTML = rows.slice(0,5).map(x=>{
        const mins = Math.max(0, Math.round((new Date(x.arrT) - new Date())/60000));
        if(mins <= 1) anyDue = true;
        const cls = classify(mins);
        const eta = mins<=1 ? 'DUE' : `${mins} min`;
        return `<tr class="${cls}"><td>${eta}</td><td>${x.rn || ''}</td><td>${x.destNm || ''}</td></tr>`;
      }).join('');

      controlRunner(runner, anyDue);
    };

    render(loop,    '#trainLoopBody',    '#trainLoopRun');
    render(kimball, '#trainKimballBody', '#trainKimballRun');
  }catch(err){
    const msg = 'Train error: ' + (err?.message || err);
    ['#trainLoopBody','#trainKimballBody'].forEach(id=>{
      const el=document.querySelector(id);
      if(el) el.innerHTML = `<tr><td colspan="3">${msg}</td></tr>`;
    });
    controlRunner(document.querySelector('#trainLoopRun'), false);
    controlRunner(document.querySelector('#trainKimballRun'), false);
  }
}

async function loadBuses(){
  try{
    const [eastResp, westResp] = await Promise.all([
      fetchJSON('/api/bus?stpid=17833&rt=77'),
      fetchJSON('/api/bus?stpid=14920&rt=77')
    ]);

    const render = (resp, tbodySel, runnerSel) => {
      const tbody = document.querySelector(tbodySel);
      const runner = document.querySelector(runnerSel);
      if (!tbody) return;

      const apiError = resp?.error;
      const rows = Array.isArray(resp) ? resp : (resp?.rows || []);

      if (apiError) {
        tbody.innerHTML = `<tr><td colspan="3">API error: ${apiError}</td></tr>`;
        controlRunner(runner, false);
        return;
      }

      if (!rows.length) {
        tbody.innerHTML = '<tr><td colspan="3">No predictions</td></tr>';
        controlRunner(runner, false);
        return;
      }

      let anyDue = false;
      tbody.innerHTML = rows.slice(0,5).map(x=>{
        const mins = (x.prdctdn === 'DUE') ? 0 : parseInt(x.prdctdn, 10);
        if (Number.isFinite(mins) && mins <= 1) anyDue = true;
        const cls = Number.isFinite(mins) ? classify(mins) : 'ok';
        const eta = !Number.isFinite(mins) ? '‚Äî' : (mins<=1 ? 'DUE' : `${mins} min`);
        return `<tr class="${cls}"><td>${eta}</td><td>${x.vid || ''}</td><td>${x.des || ''}</td></tr>`;
      }).join('');

      controlRunner(runner, anyDue);
    };

    render(eastResp, '#busEastBody', '#busEastRun');
    render(westResp, '#busWestBody', '#busWestRun');
  }catch(err){
    const msg = 'Bus error: ' + (err?.message || err);
    ['#busEastBody','#busWestBody'].forEach(id=>{
      const el=document.querySelector(id);
      if(el) el.innerHTML = `<tr><td colspan="3">${msg}</td></tr>`;
    });
    controlRunner(document.querySelector('#busEastRun'), false);
    controlRunner(document.querySelector('#busWestRun'), false);
  }
}

/* ===== Refresh cadence ===== */
async function refresh(){
  await Promise.allSettled([ loadTrains(), loadBuses() ]);
  setStamp();
}
refresh();
setInterval(refresh, 20_000);   // arrivals

loadWeather();
setInterval(loadWeather, 5 * 60 * 1000); // weather every 5 min
</script>
</body>
</html>
